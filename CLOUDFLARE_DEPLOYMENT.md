# Cloudflare Pages Deployment Guide

## Overview

This project is configured to deploy to Cloudflare Pages with full server-side rendering (SSR) support using Next.js App Router.

## Configuration

### 1. Cloudflare Pages Configuration

**Note:** This project uses **Cloudflare Pages**, not Cloudflare Workers. No `wrangler.toml` file is needed.

Cloudflare Pages automatically handles deployment after the build completes. The build output directory is `.vercel/output/static` which is generated by the `@cloudflare/next-on-pages` adapter.

### 2. Build Scripts

New npm scripts have been added to `package.json`:

- **`npm run pages:build`** - Builds the Next.js app for Cloudflare Pages
- **`npm run preview`** - Builds and previews locally with Wrangler
- **`npm run deploy`** - Builds and deploys to Cloudflare Pages

### 3. Dependencies

- `@cloudflare/next-on-pages` - Adapter for deploying Next.js to Cloudflare Pages

## Deployment Process

### Local Development

```bash
npm run dev
```

### Preview Locally

```bash
npm run preview
```

This will build for Cloudflare and start a local Wrangler dev server.

### Deploy to Cloudflare Pages

#### Automatic Deployment (Recommended)

Connect your GitHub repository to Cloudflare Pages. Every push to `main` will automatically trigger a deployment.

**Required Cloudflare Pages Settings:**

1. **Build command**: `pnpm run cf:build`
2. **Build output directory**: `.vercel/output/static`
3. **Node version**: Set environment variable `NODE_VERSION` to `20.17.0`
4. **Package manager**: Cloudflare will auto-detect `pnpm` from `pnpm-lock.yaml`
5. **Deploy command**: **LEAVE EMPTY** - Cloudflare Pages automatically deploys after build

**Environment Variables** (set in Cloudflare Pages dashboard):

- `NODE_VERSION`: `20.17.0`
- `MONGODB_URI`: Your MongoDB connection string
- Any other required env vars

#### Manual Deployment (Local)

For manual deployments from your local machine:

```bash
pnpm run deploy
```

**Note:** This requires `wrangler` to be installed and authenticated. For production, use automatic GitHub deployments instead.

### Build Optimization

The project includes a `.npmrc` file with optimized settings for Cloudflare Pages:

- Faster network settings with retry logic
- Reduced network concurrency to prevent timeouts
- Auto-install peers enabled

## Important Notes

### OpenNext Migration (Future)

The `@cloudflare/next-on-pages` package is deprecated and recommends migrating to OpenNext:
https://opennext.js.org/cloudflare

Consider migrating to OpenNext in the future for better long-term support.

### Environment Variables

Make sure to set these environment variables in your Cloudflare Pages project:

- `MONGODB_URI` - Your MongoDB connection string
- Any other environment variables from `.env.example`

### Supported Features

✅ Server-side rendering (SSR)
✅ Incremental Static Regeneration (ISR) with `revalidate`
✅ Dynamic routes with `generateStaticParams`
✅ Server Components
✅ MongoDB/Mongoose connections
✅ API routes (if added)

### Unsupported Features

❌ Node.js-specific APIs (use Cloudflare Workers APIs instead)
❌ `next/image` optimization (images.unoptimized is already set to true)
❌ Middleware using Node.js APIs

## SSR Pages in This Project

The following pages use server-side rendering:

- `/directory` - Fetches companies from MongoDB with hourly revalidation
- `/company/[slug]` - Dynamic company pages with hourly revalidation

Both pages use `revalidate = 3600` for Incremental Static Regeneration (ISR).
